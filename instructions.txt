
Install nginx:
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm install nginx-ingress ingress-nginx/ingress-nginx --namespace ingress-nginx --create-namespace

Install csi csi

helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
helm pull secrets-store-csi-driver/secrets-store-csi-driver --untar
helm install csi-driver ./secrets-store-csi-driver -n csi --create-namespace -f ./secrets-store-csi-driver/values.yaml





Install and Set Up vault:
kubectl create namespace vault

helm repo add hashicorp https://helm.releases.hashicorp.com
helm pull hashicorp/vault --version 0.31.0
tar -xvf vault-0.31.0.tgz

helm install vault hashicorp/vault -n vault --create-namespace -f vault/values.yaml

helm upgrade vault hashicorp/vault -n vault --create-namespace -f vault/values.yaml


Shell into pod and run:

/ $ vault operator init

Then unseal 3 times using the tokens:

vault operator unseal
vault operator unseal
vault operator unseal

Verify status:

vault status


Access ui:
Host entry: 10.10.3.27 vault.example.com

http://vault.example.com:30080/ui/vault/auth
Token: Root token ()

Deploy postgress: 

# add repo for postgres-operator
helm repo add postgres-operator-charts https://opensource.zalando.com/postgres-operator/charts/postgres-operator

# install the postgres-operator
helm install postgres-operator postgres-operator-charts/postgres-operator

# add repo for postgres-operator-ui
helm repo add postgres-operator-ui-charts https://opensource.zalando.com/postgres-operator/charts/postgres-operator-ui

# install the postgres-operator-ui
helm install postgres-operator-ui postgres-operator-ui-charts/postgres-operator-ui -n postgress --create-namespace
kubectl create -f postgres/manifest.yaml -n postgress


kubectl port-forward svc/postgres-operator-ui 8081:80


make targetNamespace: "*" in operator-ui deployment and restart


In Vault UI:

create secret engine in vault from ui - 
choose infra database
set a path i.e. database

create database connection -
select plugin i.e. postgress
connection uri - postgresql://{{username}}:{{password}}@acid-minimal-cluster.postgress.svc.cluster.local:5432/foo
give username, passwprd of db user
set password_authentication to scram-sha-256

Select "Enable without rotating"
   


create role

GIve a name[my-role], select COnnection name
select type dynamic

Create statement:  
CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
GRANT ALL PRIVILEGES ON DATABASE foo TO "{{name}}";



create auth kubernetes

Create auth chossing kubernetes from Access

Set kubernetes_host to 
https://10.10.3.20:6443 in configuration


create role
create access policy named internal-app

path "database/creds/my-role" {
  capabilities = ["read"]
}

bind role with access policy

CReate role named database \
   Add bound_service_account_names i.e. webapp-sa which is the sa of the deployment of application
    bound_service_account_namespaces i.e. spring [appilication deployment ns] \
    choose policy internal-app 


create SecretProviderClass

kubectl apply -f db-secret-provider.yaml -n spring


Deploy application

kubectl apply -f deployment-service.yaml -n spring

shell into pod and Verify
cat /mnt/secrets-store/db-password


Links: https://github.com/zalando/postgres-operator/blob/master/docs/quickstart.md#helm-chart,

https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-secret-store-driver

https://developer.hashicorp.com/vault/tutorials/app-integration/spring-reload-secrets#reload-dynamic-secrets

https://developer.hashicorp.com/vault/docs/secrets/databases/postgresqls



