kubectl create namespace vault

Install nginx:
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm install nginx-ingress ingress-nginx/ingress-nginx --namespace ingress-nginx --create-namespace

Install and Set Up vault:

helm repo add hashicorp https://helm.releases.hashicorp.com
helm pull hashicorp/vault --version 0.31.0
tar -xvf vault-0.31.0.tgz

helm install vault hashicorp/vault -n vault --create-namespace -f vault/values.yaml

helm upgrade vault hashicorp/vault -n vault --create-namespace -f vault/values.yaml


Shell into pod and run:

/ $ vault operator init

Then unseal 3 times using the tokens:

vault operator unseal
vault operator unseal
vault operator unseal

Verify status:

vault status


Access ui:
Host entry: 10.10.3.27 vault.example.com

http://vault.example.com:30080/ui/vault/auth
Token: Root token ()

Deploy postgress: 

# add repo for postgres-operator
helm repo add postgres-operator-charts https://opensource.zalando.com/postgres-operator/charts/postgres-operator

# install the postgres-operator
helm install postgres-operator postgres-operator-charts/postgres-operator

# add repo for postgres-operator-ui
helm repo add postgres-operator-ui-charts https://opensource.zalando.com/postgres-operator/charts/postgres-operator-ui

# install the postgres-operator-ui
helm install postgres-operator-ui postgres-operator-ui-charts/postgres-operator-ui -n postgress --create-namespace
kubectl create -f postgres/manifest.yaml -n postgress


kubectl port-forward svc/postgres-operator-ui 8081:80


make targetNamespace: "*" in operator-ui deployment and restart


In Vault UI:

create secret engine in vault- database

create database connection

create role

Create statement:  
CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
GRANT ALL PRIVILEGES ON DATABASE foo TO "{{name}}";

create auth kubernetes
create role
create access policy

path "database/creds/my-role" {
  capabilities = ["read"]
}

bind role with access policy


create SecretProviderClass

mount

NvXdgko8hE5iPLp-LOvwcnb@hello-spring-boot-app-57fb49b655-smj4m:/mnt/secrets-store$ cat db-password 
NvXdgko8hE5iPLp-LOvwcnb@hello-spring-boot-app-57fb49b655-smj4m:/mnt/secrets-store$ cat db-username 
v-kubernet-my-role-N4FK7KZlNDd5bByFFrIK-1768471195cnb@hello-spring-boot-app-57fb49b655-smj4m:/mnt/secrets-store$ 


csi

helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
helm pull secrets-store-csi-driver/secrets-store-csi-driver --untar
helm install csi-driver ./secrets-store-csi-driver -n csi --create-namespace -f ./secrets-store-csi-driver/values.yaml





Links: https://github.com/zalando/postgres-operator/blob/master/docs/quickstart.md#helm-chart,

https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-secret-store-driver

https://developer.hashicorp.com/vault/tutorials/app-integration/spring-reload-secrets#reload-dynamic-secrets

https://developer.hashicorp.com/vault/docs/secrets/databases/postgresqls

/////////////////////////////////////






/ $ vault secrets enable -path=secret -version=2 kv
Success! Enabled the kv secrets engine at: secret/
/ $ vault kv put secret/db-pass password="db-secret-password"
=== Secret Path ===
secret/data/db-pass

======= Metadata =======
Key                Value
---                -----
created_time       2026-01-15T06:14:38.098618488Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ 

